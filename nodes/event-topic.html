<style>
    .event-calc-white-text { fill: #ffffff !important; }
    .red-ui-palette-node[data-palette-type="event-topic"] .red-ui-palette-label { color: #ffffff !important; }
</style>

<script type="text/javascript">
    RED.nodes.registerType('event-topic', {
        category: 'event calc',
        color: '#758467',
        defaults: {
            name: { value: "" },
            cache: { value: "", type: "event-cache", required: true },
            topic: { value: "" },
            outputFormat: { value: "value" },
            outputOnStart: { value: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-filter",
        label: function() {
            return this.name || this.topic || "event topic";
        },
        paletteLabel: "event topic",
        labelStyle: function() { return (this.name ? "node_label_italic" : "") + " event-calc-white-text"; },
        oneditprepare: function() {
            const node = this;

            // Fetch topics from cache for autocomplete
            function fetchTopics() {
                const cacheId = $("#node-input-cache").val();
                if (cacheId) {
                    $.getJSON("event-cache/" + cacheId + "/topics", function(topics) {
                        $("#node-input-topic").autocomplete("option", "source", topics || []);
                    });
                }
            }

            // Setup autocomplete on topic input
            $("#node-input-topic").autocomplete({
                source: [],
                minLength: 0,
                delay: 0
            }).on("focus", function() {
                if (!$(this).val()) {
                    $(this).autocomplete("search", "");
                }
            });

            // Refresh topics when cache selection changes
            $("#node-input-cache").on("change", fetchTopics);

            // Initial fetch
            setTimeout(fetchTopics, 100);
        }
    });
</script>

<script type="text/html" data-template-name="event-topic">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-cache"><i class="fa fa-database"></i> Cache</label>
        <input type="text" id="node-input-cache">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-bookmark"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="sensors/room1/temp">
    </div>
    <div class="form-row">
        <label for="node-input-outputFormat"><i class="fa fa-sign-out"></i> Output Format</label>
        <select id="node-input-outputFormat" style="width:70%;">
            <option value="value">Value only (msg.payload = value)</option>
            <option value="full">Full entry (msg.payload = {value, ts, metadata})</option>
        </select>
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-outputOnStart" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-outputOnStart" style="width:auto;">Output existing cached values on deploy</label>
    </div>
</script>

<script type="text/html" data-help-name="event-topic">
    <p>Subscribes to a topic and outputs when that topic updates in the cache.</p>

    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Cache</dt>
        <dd>The event-cache config node to use</dd>
        <dt>Topic</dt>
        <dd>The exact topic to subscribe to</dd>
        <dt>Output Format</dt>
        <dd>
            <ul>
                <li><b>Value only</b>: <code>msg.payload</code> contains just the value</li>
                <li><b>Full entry</b>: <code>msg.payload</code> contains <code>{value, ts, metadata}</code></li>
            </ul>
        </dd>
        <dt>Output on deploy</dt>
        <dd>If checked, outputs the current cached value when the flow starts</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">topic + payload="subscribe"</dt>
        <dd>Dynamically change the subscription to a new topic</dd>
        <dt class="optional">payload = "refresh"</dt>
        <dd>Output the current cached value</dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>topic <span class="property-type">string</span></dt>
        <dd>The topic that was updated</dd>
        <dt>payload <span class="property-type">any</span></dt>
        <dd>The value (format depends on Output Format setting)</dd>
        <dt>timestamp <span class="property-type">number</span></dt>
        <dd>Unix timestamp when the value was cached</dd>
    </dl>
</script>
