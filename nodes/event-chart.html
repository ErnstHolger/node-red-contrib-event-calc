<style>
    .event-calc-white-text { fill: #ffffff !important; }
    .red-ui-palette-node[data-palette-type="event-chart"] .red-ui-palette-label { color: #ffffff !important; }
</style>

<script type="text/javascript">
    RED.nodes.registerType('event-chart', {
        category: 'event calc',
        color: '#758467',
        defaults: {
            name: { value: "" },
            title: { value: "Event Chart" },
            maxPoints: { value: 200, validate: RED.validators.number() },
            timestampField: { value: "timestamp" },
            valueField: { value: "payload" },
            seriesField: { value: "topic" }
        },
        inputs: 1,
        outputs: 0,
        icon: "font-awesome/fa-line-chart",
        paletteLabel: "chart",
        label: function() {
            return this.name || this.title || "Event Chart";
        },
        labelStyle: function() {
            return (this.name ? "node_label_italic" : "") + " event-calc-white-text";
        },
        oneditprepare: function() {
            var node = this;
            var chartInstance = null;
            var container = document.getElementById('event-chart-preview-container');

            // Create canvas
            var canvas = document.createElement('canvas');
            canvas.id = 'event-chart-canvas-' + node.id;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            container.innerHTML = '';
            container.appendChild(canvas);

            // Clear button
            $('#event-chart-clear-btn').on('click', function() {
                $.post('event-chart/' + node.id + '/clear', function(data) {
                    if (chartInstance) {
                        chartInstance.data.datasets = [];
                        chartInstance.update('none');
                    }
                }).fail(function() {
                    RED.notify("Failed to clear chart", "error");
                });
            });

            function loadScript(src) {
                return new Promise(function(resolve, reject) {
                    if (document.querySelector('script[src="' + src + '"]')) {
                        resolve();
                        return;
                    }
                    var script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            function initChart() {
                if (chartInstance) {
                    chartInstance.destroy();
                }

                var ctx = document.getElementById('event-chart-canvas-' + node.id);
                if (!ctx) return;

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Time' },
                                ticks: {
                                    callback: function(value) {
                                        return new Date(value).toLocaleTimeString();
                                    }
                                }
                            },
                            y: { title: { display: true, text: 'Value' } }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: node.title || 'Event Chart' }
                        }
                    }
                });

                // Subscribe to chart data updates
                RED.comms.subscribe("event-chart-data-" + node.id, function(topic, msg) {
                    if (chartInstance && msg && msg.data) {
                        updateChart(msg.data);
                    }
                });

                // Load initial data
                $.getJSON('event-chart/' + node.id + '/data', function(data) {
                    if (data && data.data) {
                        updateChart(data.data);
                    }
                });
            }

            function updateChart(data) {
                if (!chartInstance) return;

                var colors = [
                    '#2196F3', '#FF5722', '#4CAF50', '#9C27B0',
                    '#FF9800', '#00BCD4', '#E91E63', '#8BC34A',
                    '#3F51B5', '#CDDC39', '#009688', '#FFC107'
                ];
                var datasets = [];
                var i = 0;
                for (var series in data) {
                    datasets.push({
                        label: series,
                        data: data[series],
                        borderColor: colors[i % colors.length],
                        backgroundColor: colors[i % colors.length] + '20',
                        pointRadius: 2,
                        borderWidth: 2,
                        tension: 0.1,
                        fill: false
                    });
                    i++;
                }
                chartInstance.data.datasets = datasets;
                chartInstance.update('none');
            }

            // Load Chart.js
            if (typeof Chart === 'undefined') {
                loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js')
                    .then(function() {
                        setTimeout(initChart, 100);
                    })
                    .catch(function(err) {
                        container.innerHTML = '<p style="color:red">Failed to load Chart.js</p>';
                    });
            } else {
                initChart();
            }
        },
        oneditcancel: function() {
            RED.comms.unsubscribe("event-chart-data-" + this.id);
        },
        oneditsave: function() {
            RED.comms.unsubscribe("event-chart-data-" + this.id);
        }
    });
</script>

<script type="text/html" data-template-name="event-chart">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-title"><i class="fa fa-header"></i> Title</label>
        <input type="text" id="node-input-title" placeholder="Event Chart">
    </div>
    <div class="form-row">
        <label for="node-input-valueField"><i class="fa fa-line-chart"></i> Value Field</label>
        <input type="text" id="node-input-valueField" placeholder="payload">
    </div>
    <div class="form-row">
        <label for="node-input-timestampField"><i class="fa fa-clock-o"></i> Timestamp Field</label>
        <input type="text" id="node-input-timestampField" placeholder="timestamp">
    </div>
    <div class="form-row">
        <label for="node-input-seriesField"><i class="fa fa-tags"></i> Series Field</label>
        <input type="text" id="node-input-seriesField" placeholder="topic">
    </div>
    <div class="form-row">
        <label for="node-input-maxPoints"><i class="fa fa-database"></i> Max Points</label>
        <input type="number" id="node-input-maxPoints" placeholder="200">
    </div>
    <div class="form-row">
        <label><i class="fa fa-area-chart"></i> Preview</label>
        <div id="event-chart-preview-container" style="height: 250px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; background: #fafafa;">
            <p style="color:#888; text-align:center; padding-top:100px;">Loading chart...</p>
        </div>
    </div>
    <div class="form-row">
        <button type="button" id="event-chart-clear-btn" class="red-ui-button" style="width: 100%;">
            <i class="fa fa-trash"></i> Clear Chart Data
        </button>
    </div>
</script>

<script type="text/html" data-help-name="event-chart">
    <p>Displays time-series data on an interactive chart.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>The value to plot (configurable field name)</dd>
        <dt class="optional">timestamp <span class="property-type">number</span></dt>
        <dd>Unix timestamp in ms (defaults to current time)</dd>
        <dt class="optional">topic <span class="property-type">string</span></dt>
        <dd>Series name for grouping data (default: "default")</dd>
    </dl>

    <h3>Properties</h3>
    <ul>
        <li><b>Title</b> - Chart title displayed at top</li>
        <li><b>Value Field</b> - Message property for value (default: payload)</li>
        <li><b>Timestamp Field</b> - Message property for timestamp</li>
        <li><b>Series Field</b> - Message property for series name</li>
        <li><b>Max Points</b> - Maximum points per series (older points removed)</li>
    </ul>

    <h3>Usage</h3>
    <p>Connect to any node that outputs numeric data. The chart will automatically:</p>
    <ul>
        <li>Group data by series (topic)</li>
        <li>Display multiple series with different colors</li>
        <li>Show real-time updates as data arrives</li>
        <li>Limit data points to prevent memory issues</li>
    </ul>

    <h3>Clear Data</h3>
    <p>Use the "Clear Chart Data" button, or send <code>msg.payload = "_clear"</code>.</p>

    <h3>Preview</h3>
    <p>Double-click the node to see a live preview of the chart with current data.</p>
</script>
